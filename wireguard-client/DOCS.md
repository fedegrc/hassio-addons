# Home Assistant Community Add-on: WireGuard Client

WireGuard® is an extremely simple yet fast and modern VPN that utilizes state-of-the-art cryptography. It aims to be faster, simpler, leaner, and more useful than IPsec, while avoiding the massive headache. It intends to be considerably more performant than OpenVPN. WireGuard is designed as a general purpose VPN for running on embedded interfaces and super computers alike, fit for many different circumstances. Initially released for the Linux kernel, it is now cross-platform (Windows, macOS, BSD, iOS, Android) and widely deployable. It is currently under heavy development, but already it might be regarded as the most secure, easiest to use, and simplest VPN solution in the industry.

This add-on operates in **client mode**. There is a community add-on for [**server mode**](https://github.com/hassio-addons/addon-wireguard).

## Installation

Setting up WireGuard in client mode requires you to have access to an existing
WireGuard server. This could be a VPN provider that supports WireGuard, or
your own WireGuard server running elsewhere.

Follow the following steps for installation & a quick start:

1. Navigate to **Settings** → **Add-ons** → **Add-on Store** in your Home Assistant interface. Search for "WireGuard Client" or add this repository if using a custom installation.

1. Click the "Install" button to install the add-on.
1. Configure the `client.private_key` with your WireGuard client's private key.
1. Configure the `server.public_key` with your WireGuard server's public key.
1. Set the `server.endpoint` to your server's address, e.g., `vpn.example.com:51820`.
1. Configure `client.addresses` with the IP address(es) assigned to you by the server.
1. Save the configuration.
1. Start the "WireGuard Client" add-on.
1. Check the logs of the add-on to see if everything went well.
1. Test the connection by checking your external IP address.

## Configuration

This add-on operates in client mode, connecting to an external WireGuard server.
The configuration is simple, you only need to configure one client (your Home
Assistant instance) and one server peer.

**Note**: _Remember to restart the add-on when the configuration is changed._

Example add-on configuration:

```yaml
log_level: info
client:
  private_key: "client_private_key_here="
  addresses:
    - 10.0.0.2/24
  dns:
    - 1.1.1.1
    - 8.8.8.8
server:
  public_key: "server_public_key_here="
  endpoint: "vpn.example.com:51820"
  allowed_ips:
    - 0.0.0.0/0
  persistent_keep_alive: 25
```

### Advanced Configuration: Accessing Home Assistant via VPN

If you want to access your Home Assistant instance from other VPN clients using the VPN IP address, you can configure iptables rules to route traffic appropriately:

```yaml
log_level: info
client:
  private_key: "client_private_key_here="
  addresses:
    - 172.29.66.11/24
  post_up: >-
    iptables -A FORWARD -i %i -j ACCEPT; iptables -A FORWARD -o %i -j ACCEPT;
    iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE; iptables -t nat -A
    PREROUTING -i %i -p tcp --dport 8123 -j DNAT --to-destination 172.30.32.1:8123
  post_down: >-
    iptables -D FORWARD -i %i -j ACCEPT; iptables -D FORWARD -o %i -j ACCEPT;
    iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE; iptables -t nat -D
    PREROUTING -i %i -p tcp --dport 8123 -j DNAT --to-destination 172.30.32.1:8123
server:
  public_key: "server_public_key_here="
  endpoint: "vpn.example.com:51820"
  allowed_ips:
    - 172.29.66.0/24
  persistent_keep_alive: 25
```

With this configuration:
- Other VPN clients can access Home Assistant using `http://172.29.66.11:8123`
- Traffic is properly forwarded from the VPN interface to Home Assistant
- The `%i` placeholder is automatically replaced with the WireGuard interface name

**Note**: _This is just an example, don't copy and paste it! Create your own!_

### Option: `client.addresses`

A list of IP (IPv4 or IPv6) addresses (optionally with CIDR masks) assigned
to your client by the WireGuard server. These are typically provided by your
VPN provider or server administrator.

Example: `10.0.0.2/24` or `192.168.100.5/24`

### Option: `client.dns` _(optional)_

A list of DNS servers to use when the VPN tunnel is active. If not specified,
no DNS configuration will be applied and your system will use its default DNS.

Common options:
- `8.8.8.8, 8.8.4.4` (Google)
- `1.1.1.1, 1.0.0.1` (Cloudflare)

### Option: `client.private_key` _(required)_

Your base64 private key generated by `wg genkey`.
This option supports the use of `!secret`.

**Note**: You'll need to provide the corresponding public key to your server
administrator or VPN provider. You can generate the public key from your
private key using: `echo "your_private_key" | wg pubkey`

### Option: `client.interface` _(optional)_

The name of the WireGuard interface. Defaults to `wg0`. Only change this if
you have specific networking requirements.

### Option: `client.fwmark` _(optional)_

A 32-bit fwmark for outgoing packets. May be specified in hexadecimal by
prepending "0x". If you don't know what this is, then you probably don't
need it.

### Option: `client.table` _(optional)_

Controls the routing table to which routes are added. Setting it to `off`
disables the creation of routes altogether.

### Option: `client.pre_up` _(optional)_

Allows you to run commands before WireGuard is started.

### Option: `client.pre_down` _(optional)_

Allows you to run commands before WireGuard is stopped.

### Option: `client.post_up` _(optional)_

Allows you to run commands after WireGuard has been started. This is commonly used to configure iptables rules for traffic forwarding and NAT.

The `%i` placeholder will be automatically replaced with the actual WireGuard interface name (e.g., `wg0`).

Example for forwarding traffic and enabling access to Home Assistant:
```yaml
post_up: >-
  iptables -A FORWARD -i %i -j ACCEPT; iptables -A FORWARD -o %i -j ACCEPT;
  iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE; iptables -t nat -A
  PREROUTING -i %i -p tcp --dport 8123 -j DNAT --to-destination 172.30.32.1:8123
```

### Option: `client.post_down` _(optional)_

Allows you to run commands after WireGuard has been stopped. This should typically clean up any rules or configurations applied in `post_up`.

Example that cleans up the iptables rules from the `post_up` example:
```yaml
post_down: >-
  iptables -D FORWARD -i %i -j ACCEPT; iptables -D FORWARD -o %i -j ACCEPT;
  iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE; iptables -t nat -D
  PREROUTING -i %i -p tcp --dport 8123 -j DNAT --to-destination 172.30.32.1:8123
```

### Option: `client.mtu` _(optional)_

The MTU is automatically determined from the endpoint addresses or the
system default route, which is usually a sane choice.

However, to manually specify an MTU to override this automatic discovery,
this value may be specified explicitly. Common values are `1420` or `1280`.

### Option: `server.public_key`

The base64 public key of your WireGuard server. This is provided by your
VPN provider or server administrator. This option supports the use of `!secret`.

### Option: `server.endpoint`

The server endpoint in the format `hostname:port` or `ip:port`. This is where
your client will connect to.

Examples: `vpn.example.com:51820`, `203.0.113.1:51820`

### Option: `server.allowed_ips` _(optional)_

A list of IP addresses (IPv4 or IPv6) with CIDR masks that define which
traffic should be routed through the VPN tunnel.

- `0.0.0.0/0` - Route all IPv4 traffic through VPN
- `0.0.0.0/0, ::/0` - Route all traffic (IPv4 and IPv6) through VPN
- `10.0.0.0/8` - Only route private network traffic through VPN

If not specified, defaults to `0.0.0.0/0, ::/0` (all traffic).

### Option: `server.persistent_keep_alive` _(optional)_

A seconds interval, between 1 and 65535 inclusive, of how often to send an
authenticated empty packet to the server for the purpose of keeping a stateful
firewall or NAT mapping valid persistently.

This is especially important for client connections behind NAT. A value of
`25` seconds is recommended for most home setups.

If set to `0` or omitted, this option is disabled.

### Option: `server.pre_shared_key` _(optional)_

A base64 preshared key generated by `wg genpsk`. This option adds an additional
layer of symmetric-key cryptography to be mixed into the already existing
public-key cryptography, for post-quantum resistance.

This must match the pre-shared key configured on the server for your client.

### Option: `log_level` _(optional)_

The `log_level` option controls the level of log output by the addon and can
be changed to be more or less verbose, which might be useful when you are
dealing with an unknown issue. Possible values are:

- `trace`: Show every detail, like all called internal functions.
- `debug`: Shows detailed debug information.
- `info`: Normal (usually) interesting events.
- `warning`: Exceptional occurrences that are not errors.
- `error`: Runtime errors that do not require immediate action.
- `fatal`: Something went terribly wrong. Add-on becomes unusable.

Please note that each level automatically includes log messages from a
more severe level, e.g., `debug` also shows `info` messages. By default,
the `log_level` is set to `info`, which is the recommended setting unless
you are troubleshooting.

## Getting your client public key

If you need to provide your client's public key to a server administrator
or VPN provider, you can generate it from your private key:

```bash
echo "your_private_key_here" | wg pubkey
```

Replace `your_private_key_here` with your actual base64 private key.

## WireGuard status API

This add-on provides a simple WireGuard client status API. This API shows
the connection status to your server.

With the use of the [Home Assistant RESTful][ha-rest] integration, you can
monitor your VPN connection status.

Example:

```yaml
sensor:
  - platform: rest
    resource: http://a0d7b954-wireguard-client
    name: "WireGuard Status"
    value_template: "{{ value_json.status }}"
```

The API returns JSON with the following structure:
```json
{
  "status": "connected|disconnected|stale|never_connected",
  "server": {
    "public_key": "server_public_key",
    "endpoint": "server.example.com:51820",
    "latest_handshake": 1234567890,
    "handshake_age": 30,
    "transfer_rx": 1024000,
    "transfer_tx": 512000
  }
}
```

[wireguard-logo]: wireguard-logo.svg

